# ESP32桌面助手与微信小程序通信指南

## 1. 通信概述

ESP32桌面助手通过HTTP RESTful API提供服务，微信小程序可以通过Wi-Fi网络与ESP32建立通信。ESP32作为Web服务器，监听HTTP请求，微信小程序作为客户端发送请求并处理响应。

## 2. 通信前提

1. ESP32已连接到Wi-Fi网络并获取IP地址
2. 微信小程序运行在与ESP32相同的Wi-Fi网络下
3. 微信小程序已获取网络通信权限

## 3. 连接流程

1. **发现设备**：
   - 微信小程序通过用户手动输入ESP32的IP地址进行连接
   - 或通过mDNS服务发现ESP32设备（如果ESP32已配置mDNS服务）

2. **建立连接**：
   - 微信小程序向ESP32的IP地址发送HTTP请求
   - 默认端口为80（可在ESP32配置中修改）
   - 基础URL格式：`http://<ESP32_IP>/`

3. **验证连接**：
   - 向根路径发送GET请求，如果收到"ESP32 Smart Desktop Assistant API"响应，则连接成功

## 4. API接口说明

### 4.1 获取设备状态

```
GET http://<ESP32_IP>/api/status
```

**响应示例**：
```json
{
  "current_time": {
    "year": 2024,
    "month": 5,
    "date": 15,
    "hour": 10,
    "minute": 30,
    "second": 45
  },
  "time_format_24h": true,
  "alarm": {
    "hour": 7,
    "minute": 0,
    "enabled": false
  },
  "timer": {
    "hours": 0,
    "minutes": 10,
    "seconds": 0,
    "running": false
  },
  "reminder": {
    "title": "会议",
    "description": "项目进度讨论",
    "datetime": "2024-05-15T14:00:00"
  }
}
```

### 4.2 设置时间

```
POST http://<ESP32_IP>/api/time
Content-Type: application/json

{
  "year": 2024,
  "month": 5,
  "date": 15,
  "hour": 10,
  "minute": 30,
  "second": 0
}
```

**响应示例**：
```json
{
  "status": "ok",
  "message": "Time set successfully"
}
```

### 4.3 设置时间格式

```
POST http://<ESP32_IP>/api/time_format
Content-Type: application/json

{
  "format_24h": true
}
```

**响应示例**：
```json
{
  "status": "ok",
  "message": "Time format updated"
}
```

### 4.4 设置闹钟

```
POST http://<ESP32_IP>/api/alarm
Content-Type: application/json

{
  "hour": 7,
  "minute": 30,
  "enabled": true
}
```

**响应示例**：
```json
{
  "status": "ok",
  "message": "Alarm set successfully"
}
```

### 4.5 设置定时器

```
POST http://<ESP32_IP>/api/timer
Content-Type: application/json

{
  "hours": 0,
  "minutes": 10,
  "seconds": 0,
  "action": "start"  // 可选值: "start", "stop", "reset"
}
```

**响应示例**：
```json
{
  "status": "ok",
  "message": "Timer updated successfully"
}
```

### 4.6 设置提醒

```
POST http://<ESP32_IP>/api/reminder
Content-Type: application/json

{
  "title": "会议",
  "description": "项目进度讨论",
  "datetime": "2024-05-15T14:00:00"
}
```

**响应示例**：
```json
{
  "status": "ok",
  "message": "Reminder set successfully"
}
```

## 5. 微信小程序实现建议

### 5.1 页面结构

1. **设备连接页面**：
   - 输入ESP32 IP地址
   - 连接状态显示
   - 保存连接信息

2. **主控制页面**：
   - 显示当前时间
   - 时间格式切换（12/24小时）
   - 闹钟设置入口
   - 定时器控制
   - 提醒设置入口

3. **闹钟设置页面**：
   - 时间选择器
   - 启用/禁用开关

4. **定时器页面**：
   - 时间设置
   - 开始/暂停/重置按钮
   - 倒计时显示

5. **提醒设置页面**：
   - 标题输入
   - 描述输入
   - 日期时间选择器

### 5.2 通信代码示例

```javascript
// 连接到ESP32
function connectToESP32(ipAddress) {
  const baseUrl = `http://${ipAddress}`;
  
  // 测试连接
  wx.request({
    url: baseUrl,
    method: 'GET',
    success: (res) => {
      if (res.data === "ESP32 Smart Desktop Assistant API") {
        console.log("连接成功");
        // 保存IP地址到本地存储
        wx.setStorageSync('esp32_ip', ipAddress);
        return true;
      } else {
        console.error("连接失败：设备响应不正确");
        return false;
      }
    },
    fail: (err) => {
      console.error("连接失败：", err);
      return false;
    }
  });
}

// 获取设备状态
function getDeviceStatus(callback) {
  const ipAddress = wx.getStorageSync('esp32_ip');
  if (!ipAddress) {
    console.error("未设置ESP32 IP地址");
    return;
  }
  
  wx.request({
    url: `http://${ipAddress}/api/status`,
    method: 'GET',
    success: (res) => {
      callback(res.data);
    },
    fail: (err) => {
      console.error("获取状态失败：", err);
    }
  });
}

// 设置闹钟
function setAlarm(hour, minute, enabled, callback) {
  const ipAddress = wx.getStorageSync('esp32_ip');
  if (!ipAddress) {
    console.error("未设置ESP32 IP地址");
    return;
  }
  
  wx.request({
    url: `http://${ipAddress}/api/alarm`,
    method: 'POST',
    data: {
      hour: hour,
      minute: minute,
      enabled: enabled
    },
    success: (res) => {
      callback(res.data);
    },
    fail: (err) => {
      console.error("设置闹钟失败：", err);
    }
  });
}

// 其他API调用方法类似
```

### 5.3 状态更新策略

由于ESP32不支持WebSocket主动推送，建议采用以下策略保持UI与设备状态同步：

1. **定时轮询**：
   - 每隔一定时间（如5秒）请求一次设备状态
   - 适用于时间显示、定时器状态等需要实时更新的信息

2. **操作后刷新**：
   - 在用户执行操作后立即请求一次设备状态
   - 确保UI显示最新状态

3. **页面切换刷新**：
   - 在页面显示或切换时请求设备状态
   - 保证用户看到的始终是最新信息

## 6. 注意事项

1. **网络权限**：
   - 微信小程序需要在`app.json`中声明网络通信域名
   - 开发阶段可开启"不校验合法域名"选项

2. **错误处理**：
   - 实现网络错误重试机制
   - 显示友好的错误提示
   - 网络断开时缓存最后操作，恢复连接后重试

3. **用户体验**：
   - 添加加载指示器
   - 操作反馈（成功/失败提示）
   - 离线模式提示

4. **安全性**：
   - 考虑添加简单的认证机制
   - 限制仅在本地网络访问

5. **兼容性**：
   - 测试不同微信版本
   - 适配不同屏幕尺寸

通过以上方法，微信小程序可以与ESP32桌面助手建立稳定的通信，实现远程控制和状态监控功能。